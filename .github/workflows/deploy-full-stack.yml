name: Deploy Full Stack to VM

on:
  push:
    branches:
      - main
    paths:
      - 'core-service/**'
      - 'learner-web-app/**'
      - 'docker-compose.yml'
  workflow_dispatch:

env:
  DEPLOY_PATH: /home/ubuntu/learnora

jobs:
  deploy:
    name: Deploy Full Stack to Ubuntu VM
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/deploy_key << 'SSHKEY'
          ${{ secrets.VM_SSH_KEY }}
          SSHKEY
          sed -i 's/\r$//' ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H 86.50.20.100 >> ~/.ssh/known_hosts
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ubuntu@86.50.20.100 "echo 'SSH connection successful'"
      
      - name: Create .env file for core-service
        run: |
          cat > core-service/.env << 'EOF'
          APP_ENV=${{ secrets.APP_ENV || 'production' }}
          DEBUG=${{ secrets.DEBUG || 'False' }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          DB_ECHO=${{ secrets.DB_ECHO || 'False' }}
          LANGSMITH_TRACING=${{ secrets.LANGSMITH_TRACING || 'false' }}
          LANGSMITH_ENDPOINT=${{ secrets.LANGSMITH_ENDPOINT || 'https://eu.api.smith.langchain.com' }}
          GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
          EOF
          
          # Add optional variables only if they are set
          if [ -n "${{ secrets.DB_POOL_SIZE }}" ]; then
            echo "DB_POOL_SIZE=${{ secrets.DB_POOL_SIZE }}" >> core-service/.env
          fi
          
          if [ -n "${{ secrets.DB_MAX_OVERFLOW }}" ]; then
            echo "DB_MAX_OVERFLOW=${{ secrets.DB_MAX_OVERFLOW }}" >> core-service/.env
          fi
          
          if [ -n "${{ secrets.LANGSMITH_API_KEY }}" ]; then
            echo "LANGSMITH_API_KEY=${{ secrets.LANGSMITH_API_KEY }}" >> core-service/.env
          fi
          
          if [ -n "${{ secrets.LANGSMITH_PROJECT }}" ]; then
            echo "LANGSMITH_PROJECT=${{ secrets.LANGSMITH_PROJECT }}" >> core-service/.env
          fi
      
      - name: Create .env file for learner-web-app
        run: |
          cat > learner-web-app/.env.production << 'EOF'
          VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL || 'http://86.50.20.100:8000' }}
          EOF
      
      - name: Copy files to VM
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ubuntu@86.50.20.100 "mkdir -p ${{ env.DEPLOY_PATH }}"
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude='core-service/.venv' \
            --exclude='core-service/__pycache__' \
            --exclude='core-service/.pytest_cache' \
            --exclude='core-service/*.pyc' \
            --exclude='learner-web-app/node_modules' \
            --exclude='learner-web-app/dist' \
            --exclude='learner-web-app/.react-router' \
            --exclude='learner-web-app/.env.local' \
            --exclude='.git' \
            ./ ubuntu@86.50.20.100:${{ env.DEPLOY_PATH }}/
      
      - name: Deploy with Docker Compose
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ubuntu@86.50.20.100 bash << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}
            
            # Stop and remove existing containers
            docker compose down || true
            
            # Build and start containers
            docker compose build --no-cache
            docker compose up -d
            
            # Clean up old images
            docker image prune -f
            
            # Check if containers are running
            sleep 10
            docker compose ps
            
            # Show logs
            docker compose logs --tail=50
          ENDSSH
      
      - name: Health Check - Backend
        run: |
          sleep 30
          curl -f http://86.50.20.100/api/v1/health || exit 1
      
      - name: Health Check - Frontend
        run: |
          curl -f http://86.50.20.100/ || exit 1
      
      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          # rm -f core-service/.env
          # rm -f learner-web-app/.env.production
